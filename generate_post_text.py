"""
å¦„æƒ³ä¼šè©±é¢¨ æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

Gemini APIã‚’ä½¿ç”¨ã—ã¦ã€å¦„æƒ³ä¼šè©±é¢¨ã®ã‚¨ãƒƒãƒãªæŠ•ç¨¿æ–‡ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹ã€‚
text_index ã‚’ã‚·ãƒ¼ãƒ‰ã«ä½¿ã„ã€ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³Ã—ãƒˆãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã‚’
æ±ºå®šçš„ã«é¸ã¶ã“ã¨ã§ã€å±¥æ­´ç®¡ç†ãªã—ã§é‡è¤‡ã‚’å›é¿ã™ã‚‹ã€‚
ï¼ˆ40ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ Ã— 8ãƒˆãƒ¼ãƒ³ = 320é€šã‚Šä¸€å·¡ã¾ã§åŒã˜ãƒšã‚¢ãªã—ï¼‰
"""

import os
from pathlib import Path

import requests


# ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ãƒ¼ãƒï¼‰ãƒ—ãƒ¼ãƒ«
SITUATIONS = [
    "å½¼å¥³ãŒä»•äº‹å¸°ã‚Šã«ç”˜ãˆã¦ãã‚‹",
    "åŒæ£²ä¸­ã®å½¼å¥³ãŒãŠé¢¨å‘‚ä¸ŠãŒã‚Šã«ãƒã‚¹ã‚¿ã‚ªãƒ«å§¿ã§",
    "å¹´ä¸Šã®ãŠå§‰ã•ã‚“ãŒãƒãƒ¼ã§éš£ã«åº§ã£ã¦ããŸ",
    "å¹¼ãªã˜ã¿ã®å¥³ã®å­ãŒä¹…ã—ã¶ã‚Šã«å†ä¼šã—ã¦å¤§äººã«ãªã£ã¦ãŸ",
    "å¾Œè¼©ã®å¥³ã®å­ãŒæ®‹æ¥­ä¸­ã«äºŒäººãã‚Šã«ãªã£ã¦",
    "éš£ã®éƒ¨å±‹ã®å¥³ã®å­ãŒè–„ç€ã§è¨ªã­ã¦ããŸ",
    "ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ—ãƒªã§ä¼šã£ãŸå­ãŒäºˆæƒ³ä»¥ä¸Šã«ç©æ¥µçš„",
    "å…ƒã‚«ãƒã‹ã‚‰æ·±å¤œã«ã€Œä¼šã„ãŸã„ã€ã¨LINE",
    "å¥³å‹é”ã¨é£²ã¿ã™ãã¦çµ‚é›»é€ƒã—ã¦",
    "å½¼å¥³ãŒå¯èµ·ãã§ã¾ã åŠåˆ†å¯ã¼ã‘ãªãŒã‚‰",
    "å…ˆè¼©ã®å½¼å¥³ãŒé…”ã£ã¦ç”˜ãˆãƒ¢ãƒ¼ãƒ‰",
    "åˆã‚³ãƒ³ã§å‡ºä¼šã£ãŸå­ã¨äºŒæ¬¡ä¼šã§äºŒäººãã‚Š",
    "å½¼å¥³ãŒæ–°ã—ã„ä¸‹ç€ã‚’è¦‹ã›ã¦ãã‚‹",
    "ã‚«ãƒ•ã‚§ã§éš£ã®å¸­ã®ç¾äººãŒãšã£ã¨ã“ã£ã¡è¦‹ã¦ã‚‹",
    "å½¼å¥³ãŒãƒ¤ã‚­ãƒ¢ãƒç„¼ã„ã¦æ‹—ã­ã¦ã‚‹",
    "æ¸©æ³‰æ—…è¡Œã§å½¼å¥³ã¨éƒ¨å±‹ã«æˆ»ã£ã¦",
    "é›¨ã®æ—¥ã«ç›¸åˆå‚˜ã§å¯†ç€",
    "å½¼å¥³ãŒæ–™ç†ä¸­ã«ã‚¨ãƒ—ãƒ­ãƒ³å§¿ã§æŒ¯ã‚Šå‘ã",
    "å¤ç¥­ã‚Šã§æµ´è¡£ã®å½¼å¥³ã¨ã¯ãã‚Œã¦äºŒäººãã‚Š",
    "å½¼å¥³ãŒã€Œä»Šæ—¥ã¯ç‰¹åˆ¥ãªæ—¥ã ã‹ã‚‰ã€ã¨æ„å‘³æ·±ã«ç¬‘ã†",
    "æ·±å¤œã®ãƒ‰ãƒ©ã‚¤ãƒ–ã§å½¼å¥³ãŒåŠ©æ‰‹å¸­ã§ã†ã¨ã†ã¨",
    "åˆã‚ã¦ã®ãŠæ³Šã‚Šãƒ‡ãƒ¼ãƒˆã§ç·Šå¼µã—ã¦ã‚‹å½¼å¥³",
    "æ˜ ç”»é¤¨ã§æš—é—˜ã®ä¸­ã€å½¼å¥³ã®æ‰‹ãŒè§¦ã‚Œã¦ãã‚‹",
    "çœŸå¤ã®å¤œã€å½¼å¥³ãŒã€Œæš‘ã„ã‹ã‚‰è„±ã„ã§ã„ã„ï¼Ÿã€",
    "å‡ºå¼µå…ˆã®ãƒ›ãƒ†ãƒ«ã§å½¼å¥³ã‹ã‚‰ãƒ“ãƒ‡ã‚ªé€šè©±",
    "å½¼å¥³ãŒã‚³ã‚¹ãƒ—ãƒ¬ã—ã¦é©šã‹ã›ã¦ãã‚‹",
    "æœèµ·ããŸã‚‰å½¼å¥³ãŒã™ã§ã«èµ·ãã¦ã¦è¦‹ã¤ã‚ã¦ãŸ",
    "å½¼å¥³ãŒã€Œå†…ç·’ã®è©±ãŒã‚ã‚‹ã®ã€ã¨è€³å…ƒã§å›ã",
    "å¤§å­¦ã®å›³æ›¸é¤¨ã§æ°—ã«ãªã‚‹ã‚ã®å­ã¨äºŒäººãã‚Š",
    "å½¼å¥³ãŒé…”ã£ã¦ã€Œå¥½ãã€ã‚’é€£å‘¼ã—ã¦ãã‚‹",
    "å…ƒã‚«ãƒã¨å¶ç„¶å†ä¼šã—ã¦æ‡ã‹ã—ã„ç©ºæ°—ã«",
    "å¹´ä¸‹ã®å¥³ã®å­ãŒã€Œæ•™ãˆã¦ãã ã•ã„ã€ã¨ä¸Šç›®é£ã„",
    "å½¼å¥³ãŒãƒãƒƒã‚µãƒ¼ã‚¸ã—ã¦ã‚ã’ã‚‹ã¨è¨€ã„å‡ºã™",
    "åŒåƒšã®å¥³ã®å­ãŒã€Œç›¸è«‡ãŒã‚ã‚‹ã€ã¨å€‹å®¤ã«èª˜ã†",
    "ãƒŠãƒ¼ã‚¹ã®å½¼å¥³ãŒä»•äº‹å¸°ã‚Šã«ã¾ã åˆ¶æœã§",
    "å½¼å¥³ãŒã€Œå†™çœŸæ’®ã£ã¦ã€ã¨ãƒãƒ¼ã‚ºã‚’å–ã‚‹",
    "ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¤ãƒ–ã«å½¼å¥³ãŒç‰¹åˆ¥ãªæ ¼å¥½ã§å¾…ã£ã¦ãŸ",
    "æµ·ã§å½¼å¥³ãŒæ–°ã—ã„æ°´ç€ã‚’æŠ«éœ²",
    "å½¼å¥³ã®éƒ¨å±‹ã«åˆã‚ã¦è¡Œã£ãŸã‚‰ã„ã„åŒ‚ã„ãŒã—ã¦",
    "çµ‚é›»å¾Œã®ã‚¿ã‚¯ã‚·ãƒ¼ã§å½¼å¥³ãŒã‚‚ãŸã‚Œã‹ã‹ã£ã¦ãã‚‹",
]

# ä¼šè©±ãƒˆãƒ¼ãƒ³ï¼ˆå£èª¿ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
TONES = [
    "ç”˜ãˆãŸå£èª¿ã®å¥³ã®å­",
    "ã¡ã‚‡ã£ã¨Sã£æ°—ã®ã‚ã‚‹ãŠå§‰ã•ã‚“",
    "æ¥ãšã‹ã—ãŒã‚Šå±‹ã§å°å£°ã®å¥³ã®å­",
    "ç©æ¥µçš„ã§å¤§èƒ†ãªå¥³ã®å­",
    "å¤©ç„¶ã§ã„ã¤ã®é–“ã«ã‹è·é›¢ãŒè¿‘ã„å­",
    "ã‚¯ãƒ¼ãƒ«ã ã‘ã©å®Ÿã¯ç…§ã‚Œã¦ã‚‹å­",
    "ã¡ã‚‡ã£ã¨é…”ã£ã¦ã¦ç´ ç›´ã«ãªã£ã¦ã‚‹å­",
    "ã„ãŸãšã‚‰ã£å­ã£ã½ãã¦æŒ‘ç™ºçš„ãªå­",
]


def get_situation_and_tone(text_index: int) -> tuple[str, str]:
    """
    text_index ã‹ã‚‰æ±ºå®šçš„ã«ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒˆãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã‚’é¸æŠã€‚
    40 Ã— 8 = 320 é€šã‚ŠãŒä¸€å·¡ã™ã‚‹ã¾ã§åŒã˜ãƒšã‚¢ã¯æ¥ãªã„ã€‚
    """
    total_combos = len(SITUATIONS) * len(TONES)
    combo_index = text_index % total_combos
    
    situation_idx = combo_index % len(SITUATIONS)
    tone_idx = combo_index // len(SITUATIONS)
    
    return SITUATIONS[situation_idx], TONES[tone_idx]


def generate_post_text_gemini(
    api_key: str,
    text_index: int = 0,
) -> str:
    """
    Gemini APIã‚’ä½¿ã£ã¦å¦„æƒ³ä¼šè©±é¢¨ã®æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆã™ã‚‹ã€‚
    text_index ã§ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³Ã—ãƒˆãƒ¼ãƒ³ãŒæ±ºã¾ã‚‹ãŸã‚ã€
    å±¥æ­´ç®¡ç†ãªã—ã§è‡ªç„¶ã«å¤šæ§˜æ€§ãŒä¿ãŸã‚Œã‚‹ã€‚
    
    Args:
        api_key: Gemini API Key
        text_index: ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆpost_status.jsonã®text_indexï¼‰
    
    Returns:
        ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿æ–‡
    """
    situation, tone = get_situation_and_tone(text_index)
    
    print(f"  ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³: {situation}")
    print(f"  ãƒˆãƒ¼ãƒ³: {tone}")

    prompt = f"""ã‚ãªãŸã¯Twitterï¼ˆXï¼‰ã®è£å¢ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
å¦„æƒ³ä¼šè©±é¢¨ã®ã‚¨ãƒƒãƒãªæŠ•ç¨¿æ–‡ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€ä»Šå›ã®ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€‘{situation}
ã€å¥³ã®å­ã®å£èª¿ã€‘{tone}

ã€ãƒ«ãƒ¼ãƒ«ã€‘
1. å¥³ã®å­ã®ã‚»ãƒªãƒ•ã¨ã€ãã®å ´é¢ã®è‡¨å ´æ„ŸãŒä¼ã‚ã‚‹çŸ­ã„æå†™ã‚’æ··ãœã‚‹
2. ç›´æ¥çš„ã™ãã‚‹ä¸‹å“ãªè¡¨ç¾ã¯é¿ã‘ã€æƒ³åƒåŠ›ã‚’æ»ãç«‹ã¦ã‚‹ã€Œãƒãƒ©ãƒªã‚ºãƒ ã€ã‚’æ„è­˜
3. çµµæ–‡å­—ã‚’2ã€œ4å€‹ä½¿ã†ï¼ˆğŸ’•ğŸ¥ºğŸ™ˆâœ¨ğŸ’‹ğŸ‘€ğŸ”¥â¤ï¸â€ğŸ”¥ ãªã©ï¼‰
4. å…¨ä½“ã§100ã€œ200æ–‡å­—ç¨‹åº¦ï¼ˆTwitterã®1æŠ•ç¨¿ã«åã¾ã‚‹é•·ã•ï¼‰
5. èª­ã‚“ã ç”·æ€§ãŒã€Œç¶šããŒæ°—ã«ãªã‚‹ã€ã€Œã‚‚ã£ã¨è¦‹ãŸã„ã€ã¨æ€ã†ã‚ˆã†ãªä½™éŸ»ã‚’æ®‹ã™
6. æ”¹è¡Œã‚’åŠ¹æœçš„ã«ä½¿ã£ã¦èª­ã¿ã‚„ã™ã
7. ã‚»ãƒªãƒ•ã¯ã€Œã€ã§å›²ã‚€
8. ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯ä¸è¦
9. æœ€å¾Œã«ä½™éŸ»ã‚’æ®‹ã™ä¸€æ–‡ã§ç· ã‚ã‚‹

ã€å‡ºåŠ›ã€‘æŠ•ç¨¿æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã‚„å‰ç½®ãã¯ä¸è¦ã§ã™ã€‚"""

    try:
        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"
        
        payload = {
            "contents": [
                {
                    "parts": [
                        {"text": prompt}
                    ]
                }
            ],
            "generationConfig": {
                "temperature": 1.2,
                "topP": 0.95,
                "topK": 40,
                "maxOutputTokens": 500,
            },
            "safetySettings": [
                {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
            ]
        }
        
        response = requests.post(url, json=payload, timeout=30)
        response.raise_for_status()
        
        data = response.json()
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        candidates = data.get("candidates", [])
        if not candidates:
            print("è­¦å‘Š: Geminiã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™")
            return None
        
        text = candidates[0].get("content", {}).get("parts", [{}])[0].get("text", "")
        
        # å‰å¾Œã®ç©ºç™½ãƒ»æ”¹è¡Œã‚’ãƒˆãƒªãƒ 
        text = text.strip()
        
        # ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜å·ã®é™¤å»
        if text.startswith("```"):
            text = text.strip("`").strip()
        
        if text:
            print(f"  âœ“ Geminiç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ ({len(text)}æ–‡å­—)")
            return text
        else:
            print("è­¦å‘Š: ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã—ãŸ")
            return None
            
    except Exception as e:
        print(f"âœ— Gemini API ã‚¨ãƒ©ãƒ¼: {e}")
        return None


# ãƒ†ã‚¹ãƒˆç”¨
if __name__ == "__main__":
    from dotenv import load_dotenv
    load_dotenv(Path(__file__).parent / ".env")
    
    api_key = os.getenv("GEMINI_API_KEY")
    if not api_key:
        print("GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        exit(1)
    
    print("=== å¦„æƒ³ä¼šè©±ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ ===\n")
    
    for i in range(3):
        print(f"\n--- ãƒ†ã‚¹ãƒˆ (index={i}) ---")
        text = generate_post_text_gemini(api_key, text_index=i)
        if text:
            print(f"\n{text}\n")
        print("-" * 40)
